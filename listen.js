!function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/orcaal/",n(n.s=3)}([,function(e,t,n){},,function(e,t,n){"use strict";n.r(t);n(1),n.p;const s=function(e,t,n,s){const i=document.getElementById("loadingSound"),o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){i.style.display="none",e.decodeAudioData(o.response,(function(e){n(e)}),(function(e){console.error(e)}))},s&&(o.onprogress=function(e){const t=e.loaded/e.total;s(t)}),o.send(),i.style.display="block"};window.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),window.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,window.isAndroid=/Android/.test(navigator.userAgent)&&!window.MSStream,window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};var i=class{constructor(){window.AudioContext=window.AudioContext||window.webkitAudioContext;const e=new AudioContext,t=e.createAnalyser();t.fftSize=window.isMobile?1024:2048,t.smoothingTimeConstant=0;const n=e.createGain(),i=e.createBiquadFilter();i.Q.value=10,i.type="bandpass";const o=e.createGain();o.gain.value=1,n.connect(t),t.connect(o),o.connect(e.destination),this.context=e,this.mix=n,this.filterGain=o,this.analyser=t,this.buffer=null,s(this.context,"empty.mp3",function(e){const t=this.createSource_(e,!0);t.loop=!0,t.start(0)}.bind(this))}loadSrc(e){if(this.filterGain.gain.value=1,this.input)return this.input.disconnect(),void(this.input=null);s(this.context,e,function(e){this.buffer=e}.bind(this))}play(){this.source=this.createSource_(this.buffer,!0),this.source.start(0),this.loop||(this.playTimer=setTimeout(function(){this.stop()}.bind(this),2e3*this.buffer.duration))}live(){if("suspended"===this.context.state&&this.context.resume(),window.isIOS)window.parent.postMessage("error2","*"),console.log("cant use mic on ios");else{if(this.input)return this.input.disconnect(),void(this.input=null);const e=this;navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){e.onStream_(t)})).catch((function(){e.onStreamError_()})),this.filterGain.gain.value=0}}onStream_(e){const t=this.context.createMediaStreamSource(e);t.connect(this.mix),this.input=t,this.stream=e}onStreamError_(){}setLoop(e){this.loop=e}createSource_(e,t){const n=this.context.createBufferSource();return n.buffer=e,n.loop=t,n.connect(this.mix),n}setMicrophoneInput(){}stop(){if(this.source&&(this.source.stop(0),this.source=null,clearTimeout(this.playTimer),this.playTimer=null),this.input)return this.input.disconnect(),void(this.input=null)}getAnalyserNode(){return this.analyser}setBandpassFrequency(e){null==e?(console.log("Removing bandpass filter"),this.mix.disconnect(),this.mix.connect(this.analyser)):(this.bandpass.frequency.value=e,this.mix.disconnect(),this.mix.connect(this.bandpass),this.filterGain.connect(this.analyser))}playTone(e){this.osc||(this.osc=this.context.createOscillator(),this.osc.connect(this.mix),this.osc.type="sine",this.osc.start(0)),this.osc.frequency.value=e,this.filterGain.gain.value=.2}stopTone(){this.osc.stop(0),this.osc=null}};const o="\n// The common vertex shader used for the frequency and sonogram visualizations\nattribute vec3 gPosition;\nattribute vec2 gTexCoord0;\n\nvarying vec2 texCoord;\nvarying vec3 color;\n\nvoid main()\n{\n  gl_Position = vec4(gPosition.x, gPosition.y, gPosition.z, 1.0);\n  texCoord = gTexCoord0;\n  color = vec3(1.0);\n}",r="\n// Sonogram fragment shader\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 texCoord;\nvarying vec3 color;\n\nuniform sampler2D frequencyData;\nuniform vec4 foregroundColor;\nuniform vec4 backgroundColor;\nuniform float yoffset;\n\nvoid main()\n{\n    float x = pow(256.0, texCoord.x - 1.0);\n    float y = texCoord.y + yoffset;\n\n    vec4 sample = texture2D(frequencyData, vec2(x, y));\n    float k = sample.a;\n\n    // gl_FragColor = vec4(k, k, k, 1.0);\n    // Fade out the mesh close to the edges\n    float fade = pow(cos((1.0 - texCoord.y) * 0.5 * 3.1415926535), 0.5);\n    k *= fade;\n    gl_FragColor = backgroundColor + vec4(k * color, 1.0);\n}";var a=class{constructor(e,t,n){this.program=e.createProgram(),this.gl=e;const s=this.loadShader(this.gl.VERTEX_SHADER,t);if(null==s)return;this.gl.attachShader(this.program,s),this.gl.deleteShader(s);const i=this.loadShader(this.gl.FRAGMENT_SHADER,n);if(null==i)return;this.gl.attachShader(this.program,i),this.gl.deleteShader(i),this.gl.linkProgram(this.program),this.gl.useProgram(this.program);if(!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)){const e=this.gl.getProgramInfoLog(this.program);return console.log("Error linking program:\n"+e),this.gl.deleteProgram(this.program),void(this.program=null)}const o=/(uniform|attribute)\s+\S+\s+(\S+)\s*;/g;let r=null;for(;null!=(r=o.exec(t+"\n"+n));){const e=r[2],t=e.replace(/_(.)/g,(function(e,t){return t.toUpperCase()})),n=-1;"uniform"==r[1]?this[t+"Loc"]=this.getUniform(e):"attribute"==r[1]&&(this[t+"Loc"]=this.getAttribute(e)),n>=0&&(this[t+"Loc"]=n)}}bind(){this.gl.useProgram(this.program)}loadShader(e,t){const n=this.gl.createShader(e);if(null==n)return null;if(this.gl.shaderSource(n,t),this.gl.compileShader(n),!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)){const e=this.gl.getShaderInfoLog(n);return console.log("Error compiling shader:\n"+e),this.gl.deleteShader(n),null}return n}getAttribute(e){return this.gl.getAttribLocation(this.program,e)}getUniform(e){return this.gl.getUniformLocation(this.program,e)}};class l{constructor(){this.elements=Array(16),this.loadIdentity()}scale(e,t,n){return this.elements[0]*=e,this.elements[1]*=e,this.elements[2]*=e,this.elements[3]*=e,this.elements[4]*=t,this.elements[5]*=t,this.elements[6]*=t,this.elements[7]*=t,this.elements[8]*=n,this.elements[9]*=n,this.elements[10]*=n,this.elements[11]*=n,this}translate(e,t,n){return this.elements[12]+=this.elements[0]*e+this.elements[4]*t+this.elements[8]*n,this.elements[13]+=this.elements[1]*e+this.elements[5]*t+this.elements[9]*n,this.elements[14]+=this.elements[2]*e+this.elements[6]*t+this.elements[10]*n,this.elements[15]+=this.elements[3]*e+this.elements[7]*t+this.elements[11]*n,this}rotate(e,t,n,s){const i=Math.sqrt(t*t+n*n+s*s),o=Math.sin(e*Math.PI/180),r=Math.cos(e*Math.PI/180);if(i>0){let e;const a=(t/=i)*t,h=(n/=i)*n,c=(s/=i)*s,d=t*n,u=n*s,g=s*t,m=t*o,f=n*o,y=s*o,p=1-r;e=new l,e.elements[0]=p*a+r,e.elements[1]=p*d-y,e.elements[2]=p*g+f,e.elements[3]=0,e.elements[4]=p*d+y,e.elements[5]=p*h+r,e.elements[6]=p*u-m,e.elements[7]=0,e.elements[8]=p*g-f,e.elements[9]=p*u+m,e.elements[10]=p*c+r,e.elements[11]=0,e.elements[12]=0,e.elements[13]=0,e.elements[14]=0,e.elements[15]=1,e=e.multiply(this),this.elements=e.elements}return this}frustum(e,t,n,s,i,o){const r=t-e,a=s-n,h=o-i;let c;return i<=0||o<=0||r<=0||a<=0||h<=0||(c=new l,c.elements[0]=2*i/r,c.elements[1]=c.elements[2]=c.elements[3]=0,c.elements[5]=2*i/a,c.elements[4]=c.elements[6]=c.elements[7]=0,c.elements[8]=(t+e)/r,c.elements[9]=(s+n)/a,c.elements[10]=-(i+o)/h,c.elements[11]=-1,c.elements[14]=-2*i*o/h,c.elements[12]=c.elements[13]=c.elements[15]=0,c=c.multiply(this),this.elements=c.elements),this}perspective(e,t,n,s){const i=Math.tan(e/360*Math.PI)*n,o=i*t;return this.frustum(-o,o,-i,i,n,s)}ortho(e,t,n,s,i,o){const r=t-e,a=s-n,h=o-i;let c=new l;return 0==r||0==a||0==h||(c.elements[0]=2/r,c.elements[12]=-(t+e)/r,c.elements[5]=2/a,c.elements[13]=-(s+n)/a,c.elements[10]=-2/h,c.elements[14]=-(i+o)/h,c=c.multiply(this),this.elements=c.elements),this}multiply(e){const t=new l;for(let n=0;n<4;n++)t.elements[4*n+0]=this.elements[4*n+0]*e.elements[0]+this.elements[4*n+1]*e.elements[4]+this.elements[4*n+2]*e.elements[8]+this.elements[4*n+3]*e.elements[12],t.elements[4*n+1]=this.elements[4*n+0]*e.elements[1]+this.elements[4*n+1]*e.elements[5]+this.elements[4*n+2]*e.elements[9]+this.elements[4*n+3]*e.elements[13],t.elements[4*n+2]=this.elements[4*n+0]*e.elements[2]+this.elements[4*n+1]*e.elements[6]+this.elements[4*n+2]*e.elements[10]+this.elements[4*n+3]*e.elements[14],t.elements[4*n+3]=this.elements[4*n+0]*e.elements[3]+this.elements[4*n+1]*e.elements[7]+this.elements[4*n+2]*e.elements[11]+this.elements[4*n+3]*e.elements[15];return this.elements=t.elements,this}copy(){const e=new l;for(let t=0;t<16;t++)e.elements[t]=this.elements[t];return e}get(e,t){return this.elements[4*e+t]}invert(){const e=this.get(2,2)*this.get(3,3),t=this.get(3,2)*this.get(2,3),n=this.get(1,2)*this.get(3,3),s=this.get(3,2)*this.get(1,3),i=this.get(1,2)*this.get(2,3),o=this.get(2,2)*this.get(1,3),r=this.get(0,2)*this.get(3,3),a=this.get(3,2)*this.get(0,3),l=this.get(0,2)*this.get(2,3),h=this.get(2,2)*this.get(0,3),c=this.get(0,2)*this.get(1,3),d=this.get(1,2)*this.get(0,3),u=this.get(2,0)*this.get(3,1),g=this.get(3,0)*this.get(2,1),m=this.get(1,0)*this.get(3,1),f=this.get(3,0)*this.get(1,1),y=this.get(1,0)*this.get(2,1),p=this.get(2,0)*this.get(1,1),v=this.get(0,0)*this.get(3,1),x=this.get(3,0)*this.get(0,1),b=this.get(0,0)*this.get(2,1),T=this.get(2,0)*this.get(0,1),E=this.get(0,0)*this.get(1,1),w=this.get(1,0)*this.get(0,1),S=e*this.get(1,1)+s*this.get(2,1)+i*this.get(3,1)-(t*this.get(1,1)+n*this.get(2,1)+o*this.get(3,1)),A=t*this.get(0,1)+r*this.get(2,1)+h*this.get(3,1)-(e*this.get(0,1)+a*this.get(2,1)+l*this.get(3,1)),R=n*this.get(0,1)+a*this.get(1,1)+c*this.get(3,1)-(s*this.get(0,1)+r*this.get(1,1)+d*this.get(3,1)),C=o*this.get(0,1)+l*this.get(1,1)+d*this.get(2,1)-(i*this.get(0,1)+h*this.get(1,1)+c*this.get(2,1)),D=1/(this.get(0,0)*S+this.get(1,0)*A+this.get(2,0)*R+this.get(3,0)*C),_=D*S,L=D*A,B=D*R,F=D*C,I=D*(t*this.get(1,0)+n*this.get(2,0)+o*this.get(3,0)-(e*this.get(1,0)+s*this.get(2,0)+i*this.get(3,0))),P=D*(e*this.get(0,0)+a*this.get(2,0)+l*this.get(3,0)-(t*this.get(0,0)+r*this.get(2,0)+h*this.get(3,0))),q=D*(s*this.get(0,0)+r*this.get(1,0)+d*this.get(3,0)-(n*this.get(0,0)+a*this.get(1,0)+c*this.get(3,0))),k=D*(i*this.get(0,0)+h*this.get(1,0)+c*this.get(2,0)-(o*this.get(0,0)+l*this.get(1,0)+d*this.get(2,0))),U=D*(u*this.get(1,3)+f*this.get(2,3)+y*this.get(3,3)-(g*this.get(1,3)+m*this.get(2,3)+p*this.get(3,3))),M=D*(g*this.get(0,3)+v*this.get(2,3)+T*this.get(3,3)-(u*this.get(0,3)+x*this.get(2,3)+b*this.get(3,3))),O=D*(m*this.get(0,3)+x*this.get(1,3)+E*this.get(3,3)-(f*this.get(0,3)+v*this.get(1,3)+w*this.get(3,3))),G=D*(p*this.get(0,3)+b*this.get(1,3)+w*this.get(2,3)-(y*this.get(0,3)+T*this.get(1,3)+E*this.get(2,3))),H=D*(m*this.get(2,2)+p*this.get(3,2)+g*this.get(1,2)-(y*this.get(3,2)+u*this.get(1,2)+f*this.get(2,2))),z=D*(b*this.get(3,2)+u*this.get(0,2)+x*this.get(2,2)-(v*this.get(2,2)+T*this.get(3,2)+g*this.get(0,2))),N=D*(v*this.get(1,2)+w*this.get(3,2)+f*this.get(0,2)-(E*this.get(3,2)+m*this.get(0,2)+x*this.get(1,2))),Y=D*(E*this.get(2,2)+y*this.get(0,2)+T*this.get(1,2)-(b*this.get(1,2)+w*this.get(2,2)+p*this.get(0,2)));return this.elements[0]=_,this.elements[1]=L,this.elements[2]=B,this.elements[3]=F,this.elements[4]=I,this.elements[5]=P,this.elements[6]=q,this.elements[7]=k,this.elements[8]=U,this.elements[9]=M,this.elements[10]=O,this.elements[11]=G,this.elements[12]=H,this.elements[13]=z,this.elements[14]=N,this.elements[15]=Y,this}inverse(){return this.copy().invert()}transpose(){let e=this.elements[1];return this.elements[1]=this.elements[4],this.elements[4]=e,e=this.elements[2],this.elements[2]=this.elements[8],this.elements[8]=e,e=this.elements[3],this.elements[3]=this.elements[12],this.elements[12]=e,e=this.elements[6],this.elements[6]=this.elements[9],this.elements[9]=e,e=this.elements[7],this.elements[7]=this.elements[13],this.elements[13]=e,e=this.elements[11],this.elements[11]=this.elements[14],this.elements[14]=e,this}loadIdentity(){for(let e=0;e<16;e++)this.elements[e]=0;return this.elements[0]=1,this.elements[5]=1,this.elements[10]=1,this.elements[15]=1,this}}var h=l;var c=class{constructor(e){this.xRot=0,this.yRot=0,this.zRot=0,this.scaleFactor=3,this.dragging=!1,this.curX=0,this.curY=0,e&&(this.canvas_=e)}};let d=null,u=null,g=null;var m=class{constructor(e){this.analysisType=2,this.sonogram3DWidth=256,this.sonogram3DHeight=256,this.sonogram3DGeometrySize=9.5,this.TEXTURE_HEIGHT=256,this.yoffset=0,this.backgroundColor=[.08,.08,.08,1],this.foregroundColor=[0,.7,0,1],this.canvas=e,this.initGL()}getAvailableContext(e){if(e.getContext){try{const t=e.getContext("webgl2",{antialias:!0});if(null!==t)return t}catch(e){console.log(e.mesage)}try{const t=e.getContext("webgl",{antialias:!0});if(null!==t)return t}catch(e){console.log(e.mesage)}}return null}initGL(){d=new h,u=new h,g=new h;const e=this.sonogram3DWidth,t=this.sonogram3DHeight,n=this.sonogram3DGeometrySize,s=this.backgroundColor,i=this.canvas,l=this.getAvailableContext(i);this.gl=l,this.has3DVisualizer=l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0,this.has3DVisualizer||2!=this.analysisType||(this.analysisType=0);const m=new c(i);this.cameraController=m,m.xRot=-180,m.yRot=270,m.zRot=90,m.xT=0,m.yT=-2,m.zT=-2,l.clearColor(s[0],s[1],s[2],s[3]),l.enable(l.DEPTH_TEST);let f=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0]),y=new Float32Array([1,1,0,1,0,0,1,1,0,0,1,0]);const p=f.byteLength;this.vboTexCoordOffset=p;const v=l.createBuffer();this.vbo=v,l.bindBuffer(l.ARRAY_BUFFER,v),l.bufferData(l.ARRAY_BUFFER,p+y.byteLength,l.STATIC_DRAW),l.bufferSubData(l.ARRAY_BUFFER,0,f),l.bufferSubData(l.ARRAY_BUFFER,p,y);const x=e*t;if(x>65536)throw"Sonogram 3D resolution is too high: can only handle 65536 vertices max";f=new Float32Array(3*x),y=new Float32Array(2*x);for(let s=0;s<t;s++)for(let i=0;i<e;i++)f[3*(e*s+i)+0]=n*(i-e/2)/e,f[3*(e*s+i)+1]=0,f[3*(e*s+i)+2]=n*(s-t/2)/t,y[2*(e*s+i)+0]=i/(e-1),y[2*(e*s+i)+1]=s/(t-1);const b=f.byteLength;this.vbo3DTexCoordOffset=b;const T=l.createBuffer();this.sonogram3DVBO=T,l.bindBuffer(l.ARRAY_BUFFER,T),l.bufferData(l.ARRAY_BUFFER,b+y.byteLength,l.STATIC_DRAW),l.bufferSubData(l.ARRAY_BUFFER,0,f),l.bufferSubData(l.ARRAY_BUFFER,b,y);const E=(e-1)*(t-1)*6;this.sonogram3DNumIndices=E-3600;const w=new Uint16Array(E);let S=0;for(let n=0;n<t-1;n++)for(let t=0;t<e-1;t++)w[S++]=n*e+t,w[S++]=n*e+t+1,w[S++]=(n+1)*e+t+1,w[S++]=n*e+t,w[S++]=(n+1)*e+t+1,w[S++]=(n+1)*e+t;const A=l.createBuffer();this.sonogram3DIBO=A,l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,A),l.bufferData(l.ELEMENT_ARRAY_BUFFER,w,l.STATIC_DRAW),this.frequencyShader=new a(l,o,"\n// Frequency fragment shader\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 texCoord;\nuniform sampler2D frequencyData;\nuniform vec4 foregroundColor;\nuniform vec4 backgroundColor;\nuniform float yoffset;\n\nvoid main()\n{\n    vec4 sample = texture2D(frequencyData, vec2(texCoord.x, yoffset));\n    if (texCoord.y > sample.a) {\n        // if (texCoord.y > sample.a + 1 || texCoord.y < sample.a - 1) {\n        discard;\n    }\n    float x = texCoord.y / sample.a;\n    x = x * x * x;\n    gl_FragColor = vec4(1.0); //mix(foregroundColor, backgroundColor, x);\n}"),this.waveformShader=new a(l,o,"\n// Waveform fragment shader\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 texCoord;\nuniform sampler2D frequencyData;\nuniform vec4 foregroundColor;\nuniform vec4 backgroundColor;\nuniform float yoffset;\n\nvoid main()\n{\n    vec4 sample = texture2D(frequencyData, vec2(texCoord.x, yoffset));\n    if (texCoord.y > sample.a + 0.01 || texCoord.y < sample.a - 0.01) {\n        discard;\n    }\n    float x = (texCoord.y - sample.a) / 0.01;\n    x = x * x * x;\n    gl_FragColor = mix(foregroundColor, backgroundColor, x);\n}"),this.sonogramShader=new a(l,o,r),this.has3DVisualizer&&(this.sonogram3DShader=new a(l,"\n// The vertex shader used for the 3D sonogram visualization\nattribute vec3 gPosition;\nattribute vec2 gTexCoord0;\nuniform sampler2D vertexFrequencyData;\nuniform float vertexYOffset;\nuniform mat4 worldViewProjection;\nuniform float verticalScale;\n\nvarying vec2 texCoord;\nvarying vec3 color;\n\n\n\n/**\n * Conversion based on Wikipedia article\n * @see http://en.wikipedia.org/wiki/HSL_and_HSV#Converting_to_RGB\n */\nvec3 convertHSVToRGB(in float hue, in float saturation, in float lightness) {\n  float chroma = lightness * saturation;\n  float hueDash = hue / 60.0;\n  float x = chroma * (1.0 - abs(mod(hueDash, 2.0) - 1.0));\n  vec3 hsv = vec3(0.0);\n\n  if(hueDash < 1.0) {\n    hsv.r = chroma;\n    hsv.g = x;\n  } else if (hueDash < 2.0) {\n    hsv.r = x;\n    hsv.g = chroma;\n  } else if (hueDash < 3.0) {\n    hsv.g = chroma;\n    hsv.b = x;\n  } else if (hueDash < 4.0) {\n    hsv.g = x;\n    hsv.b = chroma;\n  } else if (hueDash < 5.0) {\n    hsv.r = x;\n    hsv.b = chroma;\n  } else if (hueDash < 6.0) {\n    hsv.r = chroma;\n    hsv.b = x;\n  }\n\n  return hsv;\n}\n\n\nvoid main()\n{\n    float x = pow(256.0, gTexCoord0.x - 1.0);\n    vec4 sample = texture2D(vertexFrequencyData, vec2(x, gTexCoord0.y + vertexYOffset));\n    vec4 newPosition = vec4(gPosition.x, gPosition.y + verticalScale * sample.a, gPosition.z, 1.0);\n    gl_Position = worldViewProjection * newPosition;\n    texCoord = gTexCoord0;\n\n    float hue = 360.0 - ((newPosition.y / verticalScale) * 360.0);\n    color = convertHSVToRGB(hue, 1.0, 1.0);\n}",r))}initByteBuffer(){const e=this.gl,t=this.TEXTURE_HEIGHT;if(!this.freqByteData||this.freqByteData.length!=this.analyser.frequencyBinCount){const n=new Uint8Array(this.analyser.frequencyBinCount);this.freqByteData=n,this.texture&&(e.deleteTexture(this.texture),this.texture=null);const s=e.createTexture();this.texture=s,e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);const i=new Uint8Array(n.length*t);e.texImage2D(e.TEXTURE_2D,0,e.ALPHA,n.length,t,0,e.ALPHA,e.UNSIGNED_BYTE,i)}}setAnalysisType(e){(this.has3DVisualizer||2!=e)&&(this.analysisType=e)}doFrequencyAnalysis(){const e=this.freqByteData;switch(this.analysisType){case 0:this.analyser.smoothingTimeConstant=.75,this.analyser.getByteFrequencyData(e);break;case 1:case 2:this.analyser.smoothingTimeConstant=0,this.analyser.getByteFrequencyData(e);break;case 3:this.analyser.smoothingTimeConstant=.1,this.analyser.getByteTimeDomainData(e)}this.drawGL()}drawGL(){const e=this.canvas,t=this.gl,n=this.vbo,s=this.vboTexCoordOffset,i=this.sonogram3DVBO,o=this.vbo3DTexCoordOffset,r=this.sonogram3DGeometrySize,a=this.sonogram3DNumIndices,l=this.sonogram3DHeight,c=this.freqByteData,m=this.texture,f=this.TEXTURE_HEIGHT,y=this.frequencyShader,p=this.waveformShader,v=this.sonogramShader,x=this.sonogram3DShader;t.bindTexture(t.TEXTURE_2D,m),t.pixelStorei(t.UNPACK_ALIGNMENT,1),1!=this.analysisType&&2!=this.analysisType&&(this.yoffset=0),t.texSubImage2D(t.TEXTURE_2D,0,0,this.yoffset,c.length,1,t.ALPHA,t.UNSIGNED_BYTE,c),1!=this.analysisType&&2!=this.analysisType||(this.yoffset=(this.yoffset+1)%f);const b=this.yoffset;let T,E,w,S,A,R,C;switch(this.analysisType){case 0:case 3:t.bindBuffer(t.ARRAY_BUFFER,n),C=0==this.analysisType?y:p,C.bind(),T=C.gPositionLoc,E=C.gTexCoord0Loc,w=C.frequencyDataLoc,S=C.foregroundColorLoc,A=C.backgroundColorLoc,t.uniform1f(C.yoffsetLoc,.5/(f-1)),R=s;break;case 1:t.bindBuffer(t.ARRAY_BUFFER,n),v.bind(),T=v.gPositionLoc,E=v.gTexCoord0Loc,w=v.frequencyDataLoc,S=v.foregroundColorLoc,A=v.backgroundColorLoc,t.uniform1f(v.yoffsetLoc,b/(f-1)),R=s;break;case 2:{t.bindBuffer(t.ARRAY_BUFFER,i),x.bind(),T=x.gPositionLoc,E=x.gTexCoord0Loc,w=x.frequencyDataLoc,S=x.foregroundColorLoc,A=x.backgroundColorLoc,t.uniform1i(x.vertexFrequencyDataLoc,0);const n=this.yoffset/(f-1);t.uniform1f(x.yoffsetLoc,n);const s=Math.floor(n*(l-1))/(l-1);t.uniform1f(x.vertexYOffsetLoc,s),t.uniform1f(x.verticalScaleLoc,r/3.5),g.loadIdentity(),g.perspective(55,e.width/e.height,1,100),u.loadIdentity(),u.translate(0,0,-9),d.loadIdentity(),d.rotate(this.cameraController.xRot,1,0,0),d.rotate(this.cameraController.yRot,0,1,0),d.rotate(this.cameraController.zRot,0,0,1),d.translate(this.cameraController.xT,this.cameraController.yT,this.cameraController.zT);const a=new h;a.multiply(d),a.multiply(u),a.multiply(g),t.uniformMatrix4fv(x.worldViewProjectionLoc,!1,a.elements),R=o;break}}w&&t.uniform1i(w,0),S&&t.uniform4fv(S,this.foregroundColor),A&&t.uniform4fv(A,this.backgroundColor),t.enableVertexAttribArray(T),t.vertexAttribPointer(T,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(E),t.vertexAttribPointer(E,2,t.FLOAT,!1,0,R),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),0==this.analysisType||3==this.analysisType||1==this.analysisType?t.drawArrays(t.TRIANGLES,0,6):2==this.analysisType&&t.drawElements(t.TRIANGLES,a,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(T),t.disableVertexAttribArray(E)}setAnalyserNode(e){this.analyser=e}getAnalysisType(){return this.analysisType}};const f=document.querySelector("#spectrogram"),y=document.querySelector("#legend"),p=19.86218362749959,v=.0003457334974465534,x={cxRot:90,prevX:0,isRendering:!1,player:null,analyserView:null,canvas:null,attached:function(){x.onResize_(),x.init_(),window.addEventListener("resize",x.onResize_.bind(x))},load:function(e){x.player.loadSrc(e)},stop:function(){x.player.stop()},isPlaying:function(){return!!this.player.source},stopRender:function(){x.isRendering=!1},startRender:function(){x.isRendering||(x.isRendering=!0,x.draw_())},loopChanged:function(e){x.player.setLoop(e)},play:function(){x.player.play()},live:function(){x.player.live()},init_:function(){const e=new i,t=e.getAnalyserNode(),n=new m(this.canvas);n.setAnalyserNode(t),n.initByteBuffer(),x.player=e,x.analyserView=n},onResize_:function(){x.canvas=f,f.width=window.innerWidth,f.height=window.innerHeight,y.width=window.innerWidth,y.height=window.innerHeight-158,x.drawLegend_()},draw_:function(){x.isRendering&&(x.analyserView.doFrequencyAnalysis(),requestAnimationFrame(x.draw_.bind(x)))},drawLegend_:function(){const e=y.getContext("2d"),t=y.width-10;e.fillStyle="#FFFFFF",e.font="14px Roboto",e.textAlign="right",e.textBaseline="middle",e.fillText("20,000 Hz -",t,y.height-x.freqToY(2e4)),e.fillText("2,000 Hz -",t,y.height-x.freqToY(2e3)),e.fillText("200 Hz -",t,y.height-x.freqToY(200)),e.fillText("20 Hz -",t,y.height-x.freqToY(20))},freqStart:20,freqEnd:2e4,padding:30,yToFreq:function(e){const t=x.padding,n=f.height;if(n<2*t||e<t||e>n-t)return null;const s=1-(e-t)/(n-t),i=x.freqStart+(x.freqEnd-x.freqStart)*s;return p*Math.exp(v*i)},freqToY:function(e){const t=Math.log(e/p)/v,n=f.height,s=x.padding,i=(t-x.freqStart)/(x.freqEnd-x.freqStart);return x.padding+i*(n-2*s)},easeInOutCubic:function(e,t,n,s){return(e/=s/2)<1?n/2*e*e*e+t:n/2*((e-=2)*e*e+2)+t},easeInOutQuad:function(e,t,n,s){return(e/=s/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},easeInOutQuint:function(e,t,n,s){return(e/=s/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},easeInOutExpo:function(e,t,n,s){return 0==e?t:e==s?t+n:(e/=s/2)<1?n/2*Math.pow(2,10*(e-1))+t:n/2*(2-Math.pow(2,-10*--e))+t}};var b=x;var T;T=()=>{const e=document.getElementById("play-pause");let t=[],n=[],s=new Set,i=0;window.parent.postMessage("ready","*"),b.attached(),b.startRender(),b.loopChanged(!0);const o=function(){if(document.getElementById("progress-label").textContent=i+"/5",document.getElementById("progress").style.width=20*i+"%",b.stop(),e.classList.remove("playing"),5===i)return document.getElementById("blurred-background").style.display="block",void(document.getElementById("labeled-by-container").style.display="block");b.load(t[i].audioUrl),document.getElementById("timestamp").innerText=t[i].timestamp,document.getElementById("duration").innerText=t[i].duration+" seconds",document.getElementById("predicted-orca").innerText=t[i].orca?"One orca detected":"No orcas detected",document.getElementById("confidence").innerText=t[i].confidence.toFixed(2)+"% confidence",document.getElementById("location").innerText=t[i].location},r=function(){fetch("https://d14pgy6pzqfa4g.cloudfront.net/uncertainties").then(e=>e.json()).then(e=>{t=e,console.log(t),s=new Set(t.map(e=>e.id)),o()}).catch(e=>console.error("Fetch Error!",e)),i=0,n=[]};r(),e.addEventListener("click",()=>{e.classList.contains("playing")?(e.classList.remove("playing"),b.stop()):(e.classList.add("playing"),b.play())});const a=function(){e.classList.remove("playing"),b.stop()};window.addEventListener("blur",(function(){a()})),document.addEventListener("visibilitychange",(function(){a()})),document.getElementById("view-details").addEventListener("click",()=>{const e=document.getElementById("details-container"),t=document.getElementById("expand-more"),n=document.getElementById("expand-less"),s=document.getElementById("view-details-text");""==e.style.maxHeight?(e.style.maxHeight="15rem",t.style.display="none",n.style.display="block",s.textContent="Hide Details"):(e.style.maxHeight="",t.style.display="block",n.style.display="none",s.textContent="View Details")});const l=function(e,r){n.push({id:t[i].id,audioUrl:t[i].audioUrl,orca:e,extraLabel:r||""}),s.delete(t[i].id),i+=1,o()},h=function(e,t){if(!e)return;const n=e.querySelector("label");n&&(t?e.classList.add("button-hovered"):e.classList.remove("button-hovered"),n.style.visibility=t?"visible":"hidden")};document.querySelectorAll(".expandable").forEach(e=>{let t="";e.addEventListener("touchstart",()=>{window.blockMenuHeaderScroll=!0,e.classList.add("hovered"),e.querySelector(".expanded-box").style.display="flex"}),e.addEventListener("touchmove",e=>{window.blockMenuHeaderScroll&&e.preventDefault();const n=e.touches[0].pageX,s=e.touches[0].pageY,i=document.elementFromPoint(n,s);i.classList.contains("label-btn")&&t!==i&&(h(t,!1),h(i,!0),t=i)}),e.addEventListener("touchend",()=>{h(t,!1);let n=!1;"orca"===e.id&&(n=!0),l(n,t.id),e.querySelector(".expanded-box").style.display="none",e.classList.remove("hovered"),t=""})}),window.isMobile||document.querySelectorAll(".label-btn").forEach(e=>e.addEventListener("click",()=>{let t=!1;t="orca"===e.parentElement.parentElement.id||"orca"===e.parentElement.id,l(t,e.id)})),document.getElementById("skip").addEventListener("click",()=>{i+=1,o()}),document.getElementById("submit-form").addEventListener("click",()=>{const e=document.querySelector("input[name=labeled-by]:checked"),t={labels:n,expertiseLevel:e.value,unlabeled:[...s]};fetch("https://d14pgy6pzqfa4g.cloudfront.net/labeledfiles",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).catch(e=>console.error("Fetch Error!",e)),document.getElementById("blurred-background").style.display="none",document.getElementById("labeled-by-container").style.display="none",r()}),document.getElementById("back-btn").addEventListener("click",()=>{window.location.href="."}),window.onunload=()=>{const e={labels:[],expertiseLevel:"",unlabeled:[...s]};navigator.sendBeacon("https://d14pgy6pzqfa4g.cloudfront.net/labeledfiles",JSON.stringify(e))}},"loading"!=document.readyState?T():document.addEventListener("DOMContentLoaded",T)}]);